<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Match Data Filter</title>
  <link rel="stylesheet" href="/static/css/styles.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">Super Schedina</h1>
    <form method="POST" action="/">
      <!-- Championship Dropdown -->
      <div class="form-group">
        <label for="championship">Championship</label>
        <select id="championship" name="championship" class="form-control" required>
          <option value="" selected disabled>Select Championship</option>
          {% for champ in championships %}
            <option value="{{ champ }}">{{ champ }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Season Dropdown -->
      <div class="form-group">
        <label for="season">Season</label>
        <select id="season" name="season" class="form-control" required>
          <option value="" selected disabled>Select Season</option>
          {% for season in seasons %}
            <option value="{{ season }}">{{ season }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Team 1 Dropdown -->
      <div class="form-group">
        <label for="team1">Team 1</label>
        <select id="team1" name="team1" class="form-control" required>
          <option value="" selected disabled>Select Team 1</option>
        </select>
      </div>
      <!-- Team 2 Dropdown -->
      <div class="form-group">
        <label for="team2">Team 2</label>
        <select id="team2" name="team2" class="form-control" required>
          <option value="" selected disabled>Select Team 2</option>
        </select>
      </div>
      <!-- Parameter Dropdown -->
      <div class="form-group">
        <label for="parameter">Parameter</label>
        <select id="parameter" name="parameter" class="form-control" required>
          <option value="" selected disabled>Select Parameter</option>
          {% for abbreviation, full_name in parameters %}
            <option value="{{ abbreviation }}">{{ full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- Submit Button -->
      <button type="submit" class="btn btn-primary btn-block">Filter Matches</button>
    </form>

    <!-- Averages Section -->
    {% if parameter_friendly_name %}
    <div class="mt-4 p-3 bg-light border rounded">
      <h3 class="text-center">Team Averages for {{ parameter_friendly_name }}</h3>
      <div class="row">
        <div class="col-md-6">
          <h5>{{ team1 }}</h5>
          <p>Average Active: {{ avg_active_team1 | round(2) }}</p>
          <p>Average Passive: {{ avg_passive_team1 | round(2) }}</p>
        </div>
        <div class="col-md-6">
          <h5>{{ team2 }}</h5>
          <p>Average Active: {{ avg_active_team2 | round(2) }}</p>
          <p>Average Passive: {{ avg_passive_team2 | round(2) }}</p>
        </div>
      </div>
      <!-- Final Calculation Display -->
      {% if final_value is not none %}
      <div class="mt-3 text-center">
         <h4>Final Total {{ parameter_friendly_name }} next match: {{ final_value | round(2) }}</h4>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Results Section for Detailed Matches -->
    <div class="row mt-5" id="results-section" {% if header_team1 or header_team2 %} style="display: block;" {% else %} style="display: none;" {% endif %}>
      <!-- Team 1 Results -->
      <div class="col-md-6">
        {% if header_team1 and filtered_result_team1 %}
        <h3 class="text-center">{{ header_team1 }}</h3>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              <th>Opponent Team</th>
              <th>Home/Away</th>
              <th>Active {{ parameter_friendly_name }}</th>
              <th>Passive {{ parameter_friendly_name }}</th>
            </tr>
          </thead>
          <tbody>
            {% for match in filtered_result_team1 %}
            <tr>
              <td>{{ match.Date }}</td>
              <td>{{ match.OpponentTeam }}</td>
              <td>{{ match.Home_Away }}</td>
              <td>{{ match[selected_parameter + '_a'] }}</td>
              <td>{{ match[selected_parameter + '_p'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          {% if team1 %}<p class="text-center">No matches found for {{ team1 }}.</p>{% endif %}
        {% endif %}
      </div>

      <!-- Team 2 Results -->
      <div class="col-md-6">
        {% if header_team2 and filtered_result_team2 %}
        <h3 class="text-center">{{ header_team2 }}</h3>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              <th>Opponent Team</th>
              <th>Home/Away</th>
              <th>Active {{ parameter_friendly_name }}</th>
              <th>Passive {{ parameter_friendly_name }}</th>
            </tr>
          </thead>
          <tbody>
            {% for match in filtered_result_team2 %}
            <tr>
              <td>{{ match.Date }}</td>
              <td>{{ match.OpponentTeam }}</td>
              <td>{{ match.Home_Away }}</td>
              <td>{{ match[selected_parameter + '_a'] }}</td>
              <td>{{ match[selected_parameter + '_p'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          {% if team2 %}<p class="text-center">No matches found for {{ team2 }}.</p>{% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- JavaScript for Dynamic Dropdowns -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      function fetchTeams() {
        const championship = $("#championship").val();
        const season = $("#season").val();
        if (!championship || !season) {
          console.log("Both Championship and Season must be selected to fetch teams.");
          return;
        }
        $.ajax({
          url: "/get-teams",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ championship: championship, season: season }),
          success: function (response) {
            $("#team1, #team2").empty().append('<option value="" selected disabled>Select Team</option>');
            response.teams.forEach(function (team) {
              $("#team1").append(`<option value="${team}">${team}</option>`);
              $("#team2").append(`<option value="${team}">${team}</option>`);
            });
          },
          error: function () {
            console.error("Failed to fetch teams.");
          }
        });
      }
      $("#championship, #season").change(fetchTeams);
    });
  </script>
</body>
</html>
